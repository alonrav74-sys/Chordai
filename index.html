<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ChordFinder Pro - Dual Engine ğŸµ</title>
<style>
:root{--bg:#0b1022;--panel:#0f172a;--text:#e5e7eb;--brand:#22c55e;--accent:#38bdf8;--bass:#a78bfa}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(160deg,var(--bg),#0a0f1c);font-family:system-ui,-apple-system,Arial;color:var(--text);direction:rtl;padding:20px}
.wrap{max-width:1400px;margin:auto}
h1{margin:6px 0 10px;font-size:26px;color:var(--accent)}
.panel{background:#0c162b;border:1px solid #1f2a40;border-radius:16px;padding:16px;margin-top:12px}
.dual-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:12px}
@media (max-width:768px){.dual-grid{grid-template-columns:1fr}}
.engine-panel{background:#0a1324;border:2px solid #1f2a40;border-radius:12px;padding:16px}
.engine-panel.chord{border-color:var(--accent)}
.engine-panel.bass{border-color:var(--bass)}
.engine-title{font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.engine-title.chord{color:var(--accent)}
.engine-title.bass{color:var(--bass)}
.live-display{background:#0b1221;border-radius:8px;padding:12px;margin:8px 0}
.live-value{font-size:32px;font-weight:800;margin:8px 0}
.live-meta{font-size:13px;color:#94a3b8;margin-top:4px}
.badge{display:inline-flex;gap:6px;padding:6px 10px;border-radius:999px;background:#0b1221;border:1px solid #1f2937;font-size:12px;margin:2px}
.badge.chord{border-color:var(--accent);color:var(--accent)}
.badge.bass{border-color:var(--bass);color:var(--bass)}
input[type="file"],button,select{padding:10px 14px;border-radius:12px;border:1px solid #223;background:#0b1221;color:#cfe3ff;font-weight:700;cursor:pointer}
button{background:var(--brand);color:#000}
button:disabled{opacity:0.5;cursor:not-allowed}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
.status{padding:10px 14px;border-radius:12px;margin:8px 0;display:none}
.status.ok{background:#0d2e1f;border:1px solid var(--brand);color:#d7ffe6}
.status.err{background:#3f1d1d;border:1px solid #f87171;color:#ffe0e0}
.timeline{max-height:400px;overflow-y:auto;margin-top:12px;font-family:monospace;font-size:13px;line-height:1.8}
.timeline-item{padding:8px;border-bottom:1px solid #1f2a40;display:flex;justify-content:space-between;align-items:center}
.timeline-item:hover{background:#0f1a2e}
.timeline-item.active{background:#1e3a5f;border-left:3px solid var(--accent)}
audio{width:100%;margin:12px 0;border-radius:8px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin:12px 0}
.stat-card{background:#0b1221;padding:10px;border-radius:8px;text-align:center}
.stat-value{font-size:24px;font-weight:700;color:var(--brand)}
.stat-label{font-size:11px;color:#94a3b8;margin-top:4px}
</style>
</head>
<body>

<div class="wrap">
<h1>ğŸµ ChordFinder Pro - Dual Engine</h1>
<p style="color:#94a3b8;margin:0 0 12px 0">×× ×•×¢ ××§×•×¨×“×™× (v14.36) + ×× ×•×¢ ×‘×¡ × ×§×™ ×‘××§×‘×™×œ</p>

<section class="panel">
  <div class="row">
    <input id="fileInput" type="file" accept="audio/*,video/*"/>
    <select id="modeSelect">
      <option value="jazz">ğŸ· Jazz Mode</option>
      <option value="basic">Basic Mode</option>
    </select>
    <button id="analyzeBtn">ğŸ” × ×ª×—</button>
    <button id="playBtn" disabled>â–¶ ×”×©××¢</button>
  </div>
  
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="bpmValue">â€”</div>
      <div class="stat-label">BPM</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="durationValue">â€”</div>
      <div class="stat-label">Duration</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="keyValue">â€”</div>
      <div class="stat-label">Key</div>
    </div>
  </div>
  
  <div id="statusOk" class="status ok"></div>
  <div id="statusErr" class="status err"></div>
  
  <audio id="player" controls></audio>
</section>

<div class="dual-grid">
  <!-- ×× ×•×¢ ××§×•×¨×“×™× -->
  <div class="engine-panel chord">
    <div class="engine-title chord">
      ğŸ¸ ×× ×•×¢ ××§×•×¨×“×™×
      <span class="badge chord" id="chordCount">0 ××§×•×¨×“×™×</span>
    </div>
    
    <div class="live-display">
      <div style="color:#94a3b8;font-size:12px">××§×•×¨×“ × ×•×›×—×™:</div>
      <div class="live-value" style="color:var(--accent)" id="currentChord">â€”</div>
      <div class="live-meta" id="chordMeta">â€”</div>
    </div>
    
    <div class="timeline" id="chordTimeline">
      <div style="color:#94a3b8;padding:20px;text-align:center">×××ª×™×Ÿ ×œ× ×™×ª×•×—...</div>
    </div>
  </div>
  
  <!-- ×× ×•×¢ ×‘×¡ -->
  <div class="engine-panel bass">
    <div class="engine-title bass">
      ğŸµ ×× ×•×¢ ×‘×¡
      <span class="badge bass" id="bassCount">0 ×ª×•×•×™ ×‘×¡</span>
    </div>
    
    <div class="live-display">
      <div style="color:#94a3b8;font-size:12px">×ª×• ×‘×¡ × ×•×›×—×™:</div>
      <div class="live-value" style="color:var(--bass)" id="currentBass">â€”</div>
      <div class="live-meta" id="bassMeta">â€”</div>
    </div>
    
    <div class="timeline" id="bassTimeline">
      <div style="color:#94a3b8;padding:20px;text-align:center">×××ª×™×Ÿ ×œ× ×™×ª×•×—...</div>
    </div>
  </div>
</div>

</div>

<!-- âœ… ×˜×•×¢×Ÿ ×©× ×™ ×× ×•×¢×™× × ×¤×¨×“×™× -->
<script src="ChordEngineEnhanced_v14.36.js"></script>
<script src="BassEngine.js"></script>

<script>
// ××ª×—×•×œ ×©× ×™ ×× ×•×¢×™×
let chordEngine, bassEngine;

try {
  chordEngine = new ChordEngineEnhanced();
  bassEngine = new BassEngine();
  console.log('âœ… ×©× ×™ ×”×× ×•×¢×™× ××•×ª×—×œ×• (Chord v14.36 + Bass v1.0)');
} catch(e) {
  alert('âŒ ×©×’×™××” ×‘××ª×—×•×œ ×”×× ×•×¢×™×: ' + e.message);
}

// ××œ×× ×˜×™×
const fileInput = document.getElementById('fileInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const playBtn = document.getElementById('playBtn');
const player = document.getElementById('player');
const statusOk = document.getElementById('statusOk');
const statusErr = document.getElementById('statusErr');
const modeSelect = document.getElementById('modeSelect');

const bpmValue = document.getElementById('bpmValue');
const durationValue = document.getElementById('durationValue');
const keyValue = document.getElementById('keyValue');

const currentChord = document.getElementById('currentChord');
const chordMeta = document.getElementById('chordMeta');
const currentBass = document.getElementById('currentBass');
const bassMeta = document.getElementById('bassMeta');

const chordTimeline = document.getElementById('chordTimeline');
const bassTimeline = document.getElementById('bassTimeline');
const chordCount = document.getElementById('chordCount');
const bassCount = document.getElementById('bassCount');

// ××©×ª× ×™ ××¦×‘
let CHORD_RESULT = null;
let BASS_RESULT = null;

// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
function showOk(msg) {
  statusOk.textContent = msg;
  statusOk.style.display = 'block';
  statusErr.style.display = 'none';
}

function showErr(msg) {
  statusErr.textContent = msg;
  statusErr.style.display = 'block';
  statusOk.style.display = 'none';
}

function hideStatus() {
  statusOk.style.display = 'none';
  statusErr.style.display = 'none';
}

async function decodeAudioFile(file) {
  const AC = window.AudioContext || window.webkitAudioContext;
  const ctx = new AC();
  const arr = await file.arrayBuffer();
  const buf = await ctx.decodeAudioData(arr);
  return { audioBuffer: buf, url: URL.createObjectURL(file) };
}

// × ×™×ª×•×—
analyzeBtn.onclick = async () => {
  const file = fileInput.files[0];
  if (!file) {
    showErr('×‘×—×¨ ×§×•×‘×¥ ××•×“×™×•');
    return;
  }
  
  hideStatus();
  analyzeBtn.disabled = true;
  playBtn.disabled = true;
  
  currentChord.textContent = 'â€”';
  chordMeta.textContent = 'â€”';
  currentBass.textContent = 'â€”';
  bassMeta.textContent = 'â€”';
  
  chordTimeline.innerHTML = '<div style="color:#94a3b8;padding:20px;text-align:center">×× ×ª×— ××§×•×¨×“×™×...</div>';
  bassTimeline.innerHTML = '<div style="color:#94a3b8;padding:20px;text-align:center">×× ×ª×— ×‘×¡...</div>';
  
  try {
    showOk('â³ ×˜×•×¢×Ÿ ××•×“×™×•...');
    const { audioBuffer, url } = await decodeAudioFile(file);
    player.src = url;
    
    showOk('â³ ××¨×™×¥ ×©× ×™ ×× ×•×¢×™× ×‘××§×‘×™×œ...');
    
    // ×”×¤×¢×œ ×©× ×™ ×× ×•×¢×™× ×‘××§×‘×™×œ!
    const [chordResult, bassResult] = await Promise.all([
      chordEngine.detect(audioBuffer, {
        harmonyMode: modeSelect.value,
        bassMultiplier: 1.2,
        extensionMultiplier: 1.0
      }),
      bassEngine.detectBass(audioBuffer, {
        minStability: 3,
        minConfidence: 0.6
      })
    ]);
    
    CHORD_RESULT = chordResult;
    BASS_RESULT = bassResult;
    
    // ×¢×“×›×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
    bpmValue.textContent = chordResult.bpm || 'â€”';
    durationValue.textContent = chordResult.duration ? chordResult.duration.toFixed(1) + 's' : 'â€”';
    
    if (chordResult.key && chordEngine.NOTES_SHARP) {
      keyValue.textContent = chordEngine.NOTES_SHARP[chordResult.key.root] + (chordResult.key.minor ? 'm' : '');
    } else {
      keyValue.textContent = 'â€”';
    }
    
    chordCount.textContent = chordResult.chords.length + ' ××§×•×¨×“×™×';
    bassCount.textContent = bassResult.bassNotes.length + ' ×ª×•×•×™ ×‘×¡';
    
    // ×”×¦×’ timeline
    displayChordTimeline(chordResult.chords);
    displayBassTimeline(bassResult.bassNotes);
    
    // ×—×‘×¨ playback
    hookPlayback();
    
    showOk(`âœ… ×–×•×”×• ${chordResult.chords.length} ××§×•×¨×“×™× ×•-${bassResult.bassNotes.length} ×ª×•×•×™ ×‘×¡`);
    playBtn.disabled = false;
    
  } catch(e) {
    showErr('âŒ ×©×’×™××”: ' + e.message);
    console.error(e);
  } finally {
    analyzeBtn.disabled = false;
  }
};

function displayChordTimeline(chords) {
  if (!chords || chords.length === 0) {
    chordTimeline.innerHTML = '<div style="color:#94a3b8;padding:20px;text-align:center">×œ× ×–×•×”×• ××§×•×¨×“×™×</div>';
    return;
  }
  
  let html = '';
  chords.forEach((chord, idx) => {
    const time = chord.t.toFixed(1);
    const label = chord.label || '?';
    const ornament = chord.ornamentType || 'structural';
    html += `<div class="timeline-item" data-time="${chord.t}" data-type="chord">
      <span><b>${label}</b> @ ${time}s</span>
      <span style="font-size:11px;color:#94a3b8">${ornament}</span>
    </div>`;
  });
  chordTimeline.innerHTML = html;
}

function displayBassTimeline(bassNotes) {
  if (!bassNotes || bassNotes.length === 0) {
    bassTimeline.innerHTML = '<div style="color:#94a3b8;padding:20px;text-align:center">×œ× ×–×•×”×• ×ª×•×•×™ ×‘×¡</div>';
    return;
  }
  
  let html = '';
  bassNotes.forEach(note => {
    const start = note.startTime.toFixed(1);
    const dur = note.duration.toFixed(1);
    const conf = (note.confidence * 100).toFixed(0);
    html += `<div class="timeline-item" data-time="${note.startTime}" data-type="bass">
      <span><b>${note.note}</b> @ ${start}s</span>
      <span style="font-size:11px;color:#94a3b8">${dur}s (${conf}%)</span>
    </div>`;
  });
  bassTimeline.innerHTML = html;
}

function hookPlayback() {
  player.ontimeupdate = () => {
    const t = player.currentTime;
    
    // ×¢×“×›×Ÿ ××§×•×¨×“ × ×•×›×—×™
    if (CHORD_RESULT && CHORD_RESULT.chords) {
      const chord = CHORD_RESULT.chords.find((c, idx) => {
        const next = CHORD_RESULT.chords[idx + 1];
        return c.t <= t && (!next || next.t > t);
      });
      
      if (chord) {
        currentChord.textContent = chord.label || 'â€”';
        chordMeta.textContent = `${chord.t.toFixed(1)}s â€¢ ${chord.ornamentType || 'structural'}`;
        
        // ×”×“×’×© ×‘-timeline
        chordTimeline.querySelectorAll('.timeline-item').forEach(el => {
          el.classList.remove('active');
          if (parseFloat(el.dataset.time) === chord.t) {
            el.classList.add('active');
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
    }
    
    // ×¢×“×›×Ÿ ×‘×¡ × ×•×›×—×™
    if (BASS_RESULT && BASS_RESULT.bassNotes) {
      const bass = BASS_RESULT.bassNotes.find(b => 
        b.startTime <= t && b.endTime > t
      );
      
      if (bass) {
        currentBass.textContent = bass.note;
        bassMeta.textContent = `${bass.startTime.toFixed(1)}s-${bass.endTime.toFixed(1)}s â€¢ ${(bass.confidence*100).toFixed(0)}%`;
        
        // ×”×“×’×© ×‘-timeline
        bassTimeline.querySelectorAll('.timeline-item').forEach(el => {
          el.classList.remove('active');
          if (parseFloat(el.dataset.time) === bass.startTime) {
            el.classList.add('active');
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      } else {
        currentBass.textContent = 'â€”';
        bassMeta.textContent = 'â€”';
      }
    }
  };
}

playBtn.onclick = () => {
  if (player.paused) {
    player.play();
    playBtn.textContent = 'â¸ ×”×¤×¡×§';
  } else {
    player.pause();
    playBtn.textContent = 'â–¶ ×”×©××¢';
  }
};
</script>

</body>
</html>